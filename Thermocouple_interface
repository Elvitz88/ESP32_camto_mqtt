#include <Arduino.h>
#include <Wire.h>
#include <LiquidCrystal_I2C.h>
#include <Adafruit_MAX31855.h>
#include <ESP8266WiFi.h>      // à¸ªà¸³à¸«à¸£à¸±à¸šà¸šà¸­à¸£à¹Œà¸” ESP8266
#include <PubSubClient.h>     // à¸ªà¸³à¸«à¸£à¸±à¸š MQTT
#include <ArduinoJson.h>      // à¸ªà¸³à¸«à¸£à¸±à¸šà¸ªà¸£à¹‰à¸²à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ JSON

// =================================================================
// 1) âš™ï¸ Configuration (à¹à¸à¹‰à¹„à¸‚à¸„à¹ˆà¸²à¹ƒà¸™à¸ªà¹ˆà¸§à¸™à¸™à¸µà¹‰)
// =================================================================
// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
// 2) Your Wiâ€‘Fi credentials
// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
const char* ssid     = "TP-Link_61E3_2.4";
const char* password = "0800453956";

// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
// 3) MQTT Broker settings
// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
const char* mqtt_server  = "192.168.1.106";
const uint16_t mqtt_port = 1883;
const char* mqtt_user    = "admin";
const char* mqtt_pass    = "admin1234";         // <-- à¹ƒà¸ªà¹ˆ Password MQTT (à¸–à¹‰à¸²à¸¡à¸µ)

// --- Device Identity ---
const char* thermo_id = "1";     // <-- à¸•à¸±à¹‰à¸‡ ID à¹€à¸‰à¸à¸²à¸°à¸ªà¸³à¸«à¸£à¸±à¸šà¸­à¸¸à¸›à¸à¸£à¸“à¹Œà¸™à¸µà¹‰ (à¹€à¸›à¹‡à¸™à¸•à¸±à¸§à¹€à¸¥à¸‚à¹ƒà¸™à¸£à¸¹à¸›à¹à¸šà¸š String)

// =================================================================
// 2) Pin Mapping & Hardware Setup (NodeMCU ESP8266)
// =================================================================
// --- Thermocouple MAX31855 ---
#define PIN_DO   D6   // GPIO12 - MISO
#define PIN_CS   D7   // GPIO13 - CS
#define PIN_CLK  D5   // GPIO14 - SCK
Adafruit_MAX31855 thermocouple(PIN_CLK, PIN_CS, PIN_DO);

// --- LCD I2C 1602 ---
#define LCD_ADDR 0x27 // à¸–à¹‰à¸²à¸ˆà¸­à¹„à¸¡à¹ˆà¸‚à¸¶à¹‰à¸™ à¸¥à¸­à¸‡à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹€à¸›à¹‡à¸™ 0x3F
LiquidCrystal_I2C lcd(LCD_ADDR, 16, 2);

// =================================================================
// 3) Global Objects & Variables
// =================================================================
// --- MQTT ---
char topic_temperature[40];
char topic_status[40];
const char* msg_online  = "online";
const char* msg_offline = "offline";
WiFiClient   wifiClient;
PubSubClient mqttClient(wifiClient);

// --- Timing ---
unsigned long last_publish = 0;
const unsigned long publish_interval = 5000; // à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸¸à¸ 5 à¸§à¸´à¸™à¸²à¸—à¸µ (5000 ms)

// =================================================================
// Function Prototypes
// =================================================================
void connectWiFi();
void connectMQTT();
void publishTemperatureData(double tempC);


// =================================================================
// SETUP: à¸—à¸³à¸‡à¸²à¸™à¸„à¸£à¸±à¹‰à¸‡à¹€à¸”à¸µà¸¢à¸§à¹€à¸¡à¸·à¹ˆà¸­à¹€à¸›à¸´à¸”à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡
// =================================================================
void setup() {
  Serial.begin(115200);
  delay(300);
  Serial.println("\n[INFO] Booting up ESP8266 MAX31855 MQTT Probe...");

  // à¸ªà¸£à¹‰à¸²à¸‡à¸Šà¸·à¹ˆà¸­ Topic à¸ˆà¸²à¸ thermo_id
  snprintf(topic_temperature, sizeof(topic_temperature), "sensor/%s/temperature", thermo_id);
  snprintf(topic_status, sizeof(topic_status), "sensor/%s/status", thermo_id);
  Serial.printf("[INFO] Temperature Topic: %s\n", topic_temperature);
  Serial.printf("[INFO] Status Topic:      %s\n", topic_status);

  // à¹€à¸£à¸´à¹ˆà¸¡ I2C à¸”à¹‰à¸§à¸¢à¸‚à¸² SDA=D2, SCL=D1 (à¸„à¹ˆà¸²à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™à¸‚à¸­à¸‡ NodeMCU)
  Wire.begin(D2, D1);

  // à¹€à¸£à¸´à¹ˆà¸¡à¸ˆà¸­ LCD
  lcd.init();
  lcd.backlight();
  lcd.clear();
  lcd.setCursor(0,0);
  lcd.print("Sensor Starting");

  // à¹€à¸£à¸´à¹ˆà¸¡ MAX31855
  if (!thermocouple.begin()) {
    Serial.println("[ERROR] MAX31855 not found!");
    lcd.setCursor(0,1);
    lcd.print("No MAX31855!");
  }

  // à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ Wi-Fi à¹à¸¥à¸° MQTT
  connectWiFi();
  mqttClient.setServer(mqtt_server, mqtt_port);
  connectMQTT(); // à¸—à¸³à¸à¸²à¸£à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸„à¸£à¸±à¹‰à¸‡à¹à¸£à¸
}


// =================================================================
// LOOP: à¸—à¸³à¸‡à¸²à¸™à¸§à¸™à¸‹à¹‰à¸³à¹„à¸›à¹€à¸£à¸·à¹ˆà¸­à¸¢à¹†
// =================================================================
void loop() {
  // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸à¸²à¸£à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ MQTT à¹à¸¥à¸°à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¹ƒà¸«à¸¡à¹ˆà¸–à¹‰à¸²à¸«à¸¥à¸¸à¸”
  if (!mqttClient.connected()) {
    connectMQTT();
  }
  // Loop à¸™à¸µà¹‰à¸ªà¸³à¸„à¸±à¸à¸¡à¸²à¸à¸ªà¸³à¸«à¸£à¸±à¸š PubSubClient à¹€à¸à¸·à¹ˆà¸­à¹ƒà¸«à¹‰à¸£à¸±à¸š-à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸šà¸·à¹‰à¸­à¸‡à¸«à¸¥à¸±à¸‡à¹„à¸”à¹‰
  mqttClient.loop();

  // à¹ƒà¸Šà¹‰ millis() à¹ƒà¸™à¸à¸²à¸£à¸ˆà¸±à¸šà¹€à¸§à¸¥à¸²à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹à¸šà¸šà¹„à¸¡à¹ˆà¸«à¸™à¹ˆà¸§à¸‡à¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™ (non-blocking)
  unsigned long now = millis();
  if (now - last_publish >= publish_interval) {
    last_publish = now; // à¸­à¸±à¸›à¹€à¸”à¸•à¹€à¸§à¸¥à¸²à¸—à¸µà¹ˆà¸ªà¹ˆà¸‡à¸¥à¹ˆà¸²à¸ªà¸¸à¸”

    double c = thermocouple.readCelsius();

    // --- à¸ªà¹ˆà¸§à¸™à¹à¸ªà¸”à¸‡à¸œà¸¥à¸šà¸™à¸ˆà¸­ LCD ---
    lcd.setCursor(0,0);
    if (isnan(c)) {
      lcd.print("Read error      ");
      lcd.setCursor(0,1);
      lcd.print("Check wiring    ");
      Serial.println("[ERROR] Failed to read from thermocouple!");

      // à¸ªà¹ˆà¸‡à¸ªà¸–à¸²à¸™à¸° error à¹„à¸›à¸¢à¸±à¸‡ MQTT
      publishTemperatureData(NAN);

    } else {
      double f = c * 9.0 / 5.0 + 32.0;

      // à¸šà¸£à¸£à¸—à¸±à¸”à¸šà¸™: à¹à¸ªà¸”à¸‡à¸­à¸‡à¸¨à¸² C
      lcd.print("Temp: ");
      lcd.print(c, 2);
      lcd.print((char)223); // à¸ªà¸±à¸à¸¥à¸±à¸à¸©à¸“à¹Œà¸­à¸‡à¸¨à¸² Â°
      lcd.print("C   ");

      // à¸šà¸£à¸£à¸—à¸±à¸”à¸¥à¹ˆà¸²à¸‡: à¹à¸ªà¸”à¸‡à¸­à¸‡à¸¨à¸² F
      lcd.setCursor(0,1);
      lcd.print("F: ");
      lcd.print(f, 2);
      lcd.print((char)223);
      lcd.print("F      ");

      // à¹à¸ªà¸”à¸‡à¸œà¸¥à¸šà¸™ Serial Monitor
      Serial.printf("[DATA] C=%.2f, F=%.2f\n", c, f);

      // --- à¸ªà¹ˆà¸§à¸™à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ MQTT ---
      publishTemperatureData(c);
    }
  }
}

/**
 * @brief à¸ªà¸£à¹‰à¸²à¸‡ JSON payload à¹à¸¥à¸° publish à¹„à¸›à¸¢à¸±à¸‡ MQTT Broker
 * @param tempC à¸­à¸¸à¸“à¸«à¸ à¸¹à¸¡à¸´à¹ƒà¸™à¸«à¸™à¹ˆà¸§à¸¢à¹€à¸‹à¸¥à¹€à¸‹à¸µà¸¢à¸ª. à¸–à¹‰à¸²à¸­à¹ˆà¸²à¸™à¸„à¹ˆà¸²à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¹ƒà¸«à¹‰à¸ªà¹ˆà¸‡ NAN
 */
void publishTemperatureData(double tempC) {
  StaticJsonDocument<200> doc;

  if (isnan(tempC)) {
    doc["status"] = "error";
    doc["error_message"] = "Failed to read sensor";
  } else {
    doc["device_id"] = thermo_id;
    doc["temperature_celsius"] = serialized(String(tempC, 2)); // à¸ªà¹ˆà¸‡à¹€à¸›à¹‡à¸™à¸—à¸¨à¸™à¸´à¸¢à¸¡ 2 à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡
    doc["unit"] = "C";
    doc["status"] = "ok";
  }

  char json_buffer[200];
  size_t n = serializeJson(doc, json_buffer);

  Serial.printf("[MQTT] Publishing to %s: %s\n", topic_temperature, json_buffer);

  // Publish à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ à¸à¸£à¹‰à¸­à¸¡à¹à¸›à¸¥à¸‡à¸Šà¸™à¸´à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ (Type Cast) à¸•à¸£à¸‡à¸™à¸µà¹‰
  if (!mqttClient.publish(topic_temperature, (const uint8_t*)json_buffer, n, true)) {
     Serial.println("[MQTT] Failed to publish temperature data.");
  }
}

/**
 * @brief à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ Wi-Fi à¹à¸¥à¸°à¹à¸ªà¸”à¸‡à¸ªà¸–à¸²à¸™à¸°à¸šà¸™à¸ˆà¸­ LCD
 */
void connectWiFi() {
  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("Connecting WiFi");
  Serial.printf("ğŸ“¶ Connecting to WiFi %s...", ssid);

  WiFi.begin(ssid, password);
  int dot_count = 0;
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
    lcd.setCursor(dot_count, 1);
    lcd.print(".");
    dot_count++;
    if (dot_count > 15) { // à¸§à¸™à¸ˆà¸¸à¸”à¸šà¸™à¸ˆà¸­à¸–à¹‰à¸²à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸™à¸²à¸™
        lcd.setCursor(0,1);
        lcd.print("                ");
        dot_count = 0;
    }
  }
  Serial.printf("\nâœ… WiFi connected, IP: %s\n", WiFi.localIP().toString().c_str());
  lcd.clear();
  lcd.print("WiFi Connected!");
  lcd.setCursor(0,1);
  lcd.print(WiFi.localIP());
  delay(2000);
  lcd.clear();
}

/**
 * @brief à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ MQTT Broker à¸à¸£à¹‰à¸­à¸¡à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² Last Will and Testament (LWT)
 */
void connectMQTT() {
  Serial.printf("ğŸ”— Connecting to MQTT %s:%u...", mqtt_server, mqtt_port);
  while (!mqttClient.connected()) {
    lcd.clear();
    lcd.setCursor(0,0);
    lcd.print("Connecting MQTT");
    // à¸à¸³à¸«à¸™à¸” LWT: à¸–à¹‰à¸²à¸«à¸¥à¸¸à¸”à¸à¸²à¸£à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ Broker à¸ˆà¸°à¸ªà¹ˆà¸‡ "offline" à¹„à¸›à¸—à¸µà¹ˆ topic_status
    if (mqttClient.connect(thermo_id, mqtt_user, mqtt_pass, topic_status, 1, true, msg_offline)) {
      Serial.println("\nâœ… MQTT connected");
      lcd.setCursor(0,1);
      lcd.print("Connected!");
      delay(1000);

      // à¹€à¸¡à¸·à¹ˆà¸­à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸ªà¸³à¹€à¸£à¹‡à¸ˆ à¹ƒà¸«à¹‰à¸›à¸£à¸°à¸à¸²à¸¨à¸ªà¸–à¸²à¸™à¸° "online"
      mqttClient.publish(topic_status, msg_online, true); // retain = true
    } else {
      Serial.printf("\nâŒ MQTT connection failed, rc=%d. Retrying in 5 seconds...\n", mqttClient.state());
      lcd.setCursor(0,1);
      lcd.print("Failed! Retry...");
      delay(5000);
    }
  }
  lcd.clear();
}
